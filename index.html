<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>محرك المراجع الشامل</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; flex-direction:column; min-height:100vh; background:#f9f9f9; }
header { background: linear-gradient(135deg,#4CAF50,#2E7D32); color:white; padding:30px 20px; text-align:center; }
header h1 { margin:0; font-size:28px; }
main { flex:1; display:flex; flex-direction:column; align-items:center; padding:40px 20px; position:relative; }
label { font-weight:bold; margin-bottom:5px; }
input, select { padding:10px; margin-bottom:10px; width:300px; max-width:90%; border:1px solid #ccc; border-radius:8px; font-size:16px; direction:rtl; text-align:right; }
button { padding:10px 20px; margin:5px; border:none; border-radius:8px; background:#4CAF50; color:white; font-size:16px; cursor:pointer; transition:0.3s; }
button:hover { background:#388E3C; }
#suggestions { list-style:none; padding:0; margin:0; width:300px; max-height:200px; overflow-y:auto; border:1px solid #ccc; background:white; z-index:1000; display:none; position:absolute; top:0; left:320px; border-radius:8px; }
#suggestions li { padding:8px; cursor:pointer; }
#suggestions li:hover { background:#f0f0f0; }
#reference { margin:20px 0; font-size:18px; font-weight:bold; color:#333; text-align:center; word-break: break-word; }
#directLink { margin-bottom:20px; font-size:16px; color:#1a73e8; text-align:center; }
#referenceList { list-style:decimal; padding-left:20px; max-width:700px; width:100%; }
footer { display:flex; align-items:center; justify-content:center; gap:10px; padding:15px 0; background:#e0e0e0; font-size:14px; flex-wrap:wrap; }
footer img { width:40px; height:40px; border-radius:50%; }
@media (max-width:900px) { #suggestions { position:relative; left:0; width:100%; margin-bottom:20px; } main { padding:20px; } input, select { width:100%; } footer { flex-direction:column; gap:5px; font-size:12px; } footer img { width:35px;height:35px; } header h1 { font-size:22px; } }
</style>
</head>
<body>

<header>
<h1>محرك المراجع الشامل</h1>
</header>

<main>
<label for="searchTitle">عنوان البحث:</label>
<input type="text" id="searchTitle" placeholder="أدخل عنوان البحث" autocomplete="off" onkeyup="fetchSuggestions(this.value)">
<ul id="suggestions"></ul>

<label for="searchType">صيغة التوثيق:</label>
<select id="searchType">
<option value="APA">APA</option>
<option value="MLA">MLA</option>
<option value="Chicago">Chicago</option>
</select>

<div>
<button onclick="generateReferenceFromInput()">توليد التوثيق</button>
<button onclick="copyReference()">نسخ المرجع</button>
<button onclick="addToList()">إضافة للقائمة</button>
</div>

<div id="reference"></div>
<div id="directLink"></div>

<h2>قائمة المراجع:</h2>
<ul id="referenceList"></ul>

<div>
<button onclick="downloadList()">تنزيل كملف Word</button>
<button onclick="clearList()">مسح القائمة</button>
</div>
</main>

<footer>
<p>© 2025 جميع الحقوق محفوظة.</p>
<img src="images/myphoto.jpg" alt="صورتي">
</footer>

<script>
let selectedRecord = null;

// جلب اقتراحات (مثال: CrossRef)
async function fetchSuggestions(query){
    const suggestionsUl = document.getElementById("suggestions");
    suggestionsUl.innerHTML = '';
    suggestionsUl.style.display = 'none';
    selectedRecord = null;
    if(query.length < 2) return;

    let combinedItems = [];

    try{
        const response = await fetch(`https://api.crossref.org/works?query.title=${encodeURIComponent(query)}&rows=5`);
        const data = await response.json();
        combinedItems = combinedItems.concat(data.message.items);
    } catch(e){ console.error(e); }

    if(combinedItems.length > 0) suggestionsUl.style.display = 'block';
    combinedItems.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item.title[0];
        li.onclick = () => selectSuggestion(item);
        suggestionsUl.appendChild(li);
    });
}

function selectSuggestion(item){
    document.getElementById("searchTitle").value = item.title[0];
    document.getElementById("suggestions").innerHTML = '';
    document.getElementById("suggestions").style.display = 'none';
    selectedRecord = {
        title: item.title[0],
        author: item.author ? item.author.map(a=>`${a.given} ${a.family}`).join(", ") : "مجهول",
        year: item.published ? item.published['date-parts'][0][0] : "بدون سنة",
        journal: item['container-title'] && item['container-title'][0] ? item['container-title'][0] : "",
        volume: item.volume || "",
        issue: item.issue || "",
        pages: item.page || "",
        url: item.URL || ""
    };
    generateReference();
}

function generateReference(){
    if(!selectedRecord) return;
    const type = document.getElementById("searchType").value;
    let referenceText = "";
    switch(type){
        case "APA":
            referenceText = `${selectedRecord.author} (${selectedRecord.year}). ${selectedRecord.title}. ${selectedRecord.journal}${selectedRecord.volume ? `, ${selectedRecord.volume}` : ""}${selectedRecord.issue ? `(${selectedRecord.issue})` : ""}${selectedRecord.pages ? `, الصفحات ${selectedRecord.pages}` : ""}.`;
            break;
        case "MLA":
            referenceText = `${selectedRecord.author}. "${selectedRecord.title}." ${selectedRecord.journal}${selectedRecord.volume ? `, ${selectedRecord.volume}` : ""}${selectedRecord.issue ? `(${selectedRecord.issue})` : ""}${selectedRecord.pages ? `, الصفحات ${selectedRecord.pages}` : ""}. ${selectedRecord.year}.`;
            break;
        case "Chicago":
            referenceText = `${selectedRecord.author}. ${selectedRecord.title}. ${selectedRecord.journal}${selectedRecord.volume ? `, ${selectedRecord.volume}` : ""}${selectedRecord.issue ? `(${selectedRecord.issue})` : ""}${selectedRecord.pages ? `, الصفحات ${selectedRecord.pages}` : ""}. ${selectedRecord.year}.`;
            break;
    }
    document.getElementById("reference").innerText = referenceText;
    document.getElementById("directLink").innerHTML = selectedRecord.url ? `<a href="${selectedRecord.url}" target="_blank">رابط الوصول المباشر</a>` : "";
}

function generateReferenceFromInput(){ generateReference(); }
function copyReference(){
    const text = document.getElementById("reference").innerText + "\n" + document.getElementById("directLink").innerText;
    navigator.clipboard.writeText(text);
}
function addToList(){
    const refText = document.getElementById("reference").innerText + 
                   (document.getElementById("directLink").innerText ? "\n" + document.getElementById("directLink").innerText : "");
    if(refText){
        const li = document.createElement("li");
        li.textContent = refText;

        // تحديد الاتجاه حسب أول حرف
        const firstChar = refText.trim().charAt(0);
        if (/[ء-ي]/.test(firstChar)) {
            li.style.direction = "rtl";
            li.style.textAlign = "right";
        } else {
            li.style.direction = "ltr";
            li.style.textAlign = "left";
        }

        document.getElementById("referenceList").appendChild(li);
    }
}
function downloadList(){
    const items = document.getElementById("referenceList").getElementsByTagName("li");
    const references = Array.from(items).map(i=>i.textContent);
    const blob = new Blob([references.join("\n")], {type:"application/msword"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "references.doc";
    link.click();
}
function clearList(){ document.getElementById("referenceList").innerHTML = ''; }
</script>

</body>
</html>
